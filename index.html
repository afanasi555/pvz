<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PvZ Game</title>
    <style>
        canvas {
            border: 1px solid black;
        }
        #gameUI {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        #shop {
            display: none;
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            border: 1px solid black;
            background-color: white;
        }
        #shop button {
            margin: 5px;
        }
        #progressBar {
            width: 100%;
            background-color: #ccc;
            border: 1px solid #000;
            margin-top: 10px;
        }
        #progressBarFill {
            width: 0;
            height: 20px;
            background-color: green;
        }
        #winScreen {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: white;
            border: 2px solid black;
            text-align: center;
        }
        #winScreen img {
            width: 80px;
            height: 80px;
        }
    </style>
</head>
<body>
    <div id="gameUI">
        <div>Coins: <span id="coins">50</span></div>
        <div>Suns: <span id="suns">0</span></div>
        <div>Lawnmower Status: <span id="lawnmowerStatus">Idle</span></div>
    </div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="progressBar">
        <div id="progressBarFill"></div>
    </div>

    <div id="shop">
        <button onclick="selectPlant('sunflower')">Sunflower (50 suns)</button>
        <button onclick="selectPlant('peashooter')">Peashooter (100 suns)</button>
        <button onclick="closeShop()">X</button>
    </div>

    <div id="winScreen">
        <p>Congratulations! You've unlocked a new plant:</p>
        <img id="newPlantImage" src="" alt="New Plant">
        <button onclick="continueGame()">Continue</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridWidth = 80;
        const gridHeight = 100;
        let coins = 50;
        let suns = 0;
        let selectedPlant = null;
        let gameOver = false;
        let zombiesKilled = 0;
        let zombiesToKill = 10;
        let currentLevel = 1;
        const plants = [];
        const zombies = [];
        const projectiles = [];
        const lawnmowers = [{ x: 80, y: 80, used: false }];
        let plantsUnlocked = ['sunflower', 'peashooter']; // Список разблокированных растений

        const zombieTypes = {
            normal: { speed: 1, health: 100, image: 'https://github.com/afanasi555/pvz/blob/main/assets/res/normal/zombie_normal1.png' },
            conehead: { speed: 0.8, health: 200, image: 'https://github.com/afanasi555/pvz/blob/main/assets/res/normal/zombie_conehead1.png' },
            buckethead: { speed: 0.7, health: 300, image: 'https://github.com/afanasi555/pvz/blob/main/assets/res/normal/zombie_buckethead1.png' },
            runner: { speed: 1.5, health: 100, image: 'https://github.com/afanasi555/pvz/blob/main/assets/res/normal/zombie_runner1.png' }
        };

        function drawGrid() {
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 1;

            for (let x = gridWidth; x <= canvas.width; x += gridWidth) {
                ctx.beginPath();
                ctx.moveTo(x, 80);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }

            for (let y = 80; y <= canvas.height; y += gridHeight) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        function spawnZombies(level) {
            for (let i = 0; i < zombiesToKill; i++) {
                const zombieType = Object.keys(zombieTypes)[Math.floor(Math.random() * 4)];
                zombies.push({
                    x: canvas.width,
                    y: Math.floor(Math.random() * 5) * gridHeight + 80,
                    speed: zombieTypes[zombieType].speed,
                    health: zombieTypes[zombieType].health,
                    image: new Image(),
                    lane: Math.floor(Math.random() * 5)
                });
                zombies[zombies.length - 1].image.src = zombieTypes[zombieType].image;
            }
        }

        function shootProjectile(plant) {
            if (plant.type === 'peashooter') {
                projectiles.push({
                    x: plant.x + gridWidth,
                    y: plant.y + gridHeight / 2,
                    speed: 5,
                    image: new Image(),
                    type: 'pea'
                });
                projectiles[projectiles.length - 1].image.src = 'https://github.com/afanasi555/pvz/blob/main/assets/res/projectiles/pea1.png';
            }
        }

        function gameLoop() {
            if (gameOver) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            drawGrid();

            // Отображение дома и газонокосилок
            drawHouse();
            drawLawnmowers();

            // Отображение и обновление растений
            plants.forEach(plant => {
                const plantImg = new Image();
                plantImg.src = `https://github.com/afanasi555/pvz/blob/main/assets/res/normal/${plant.type}1.png`;
                ctx.drawImage(plantImg, plant.x, plant.y, gridWidth, gridHeight);

                if (plant.type === 'peashooter' || plant.type === 'repeater' || plant.type === 'corn') {
                    shootProjectile(plant);
                }
            });

            // Обработка снарядов
            projectiles.forEach((projectile, index) => {
                ctx.drawImage(projectile.image, projectile.x, projectile.y, 20, 10);
                projectile.x += projectile.speed;

                zombies.forEach((zombie, zIndex) => {
                    if (projectile.x < zombie.x + gridWidth && projectile.x + 20 > zombie.x &&
                        projectile.y < zombie.y + gridHeight && projectile.y + 10 > zombie.y) {
                        zombie.health -= 20; // Урон по зомби
                        if (zombie.health <= 0) {
                            zombies.splice(zIndex, 1); // Удаление зомби
                            zombiesKilled++;
                            if (zombiesKilled >= zombiesToKill) {
                                nextWave();
                            }
                        }
                        projectiles.splice(index, 1); // Удаление снаряда
                    }
                });
            });

            // Движение и отображение зомби
            zombies.forEach(zombie => {
                ctx.drawImage(zombie.image, zombie.x, zombie.y, gridWidth, gridHeight);
                zombie.x -= zombie.speed;

                // Проверка на газонокосилки
                lawnmowers.forEach(lawnmower => {
                    if (!lawnmower.used && zombie.x <= lawnmower.x + gridWidth && zombie.y >= lawnmower.y && zombie.y <= lawnmower.y + gridHeight / 2) {
                        zombies.splice(zombies.indexOf(zombie), 1); // Удаление зомби
                        lawnmower.used = true; // Использование газонокосилки
                        document.getElementById('lawnmowerStatus').innerText = 'Used';
                    }
                });

                // Проверка на конец игры
                if (zombie.x <= 0) {
                    alert("Game Over!");
                    gameOver = true;
                }
            });

            // Обновление полосы прогресса
            updateProgressBar();

            requestAnimationFrame(gameLoop);
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progressBarFill');
            const progressPercentage = (zombiesKilled / zombiesToKill) * 100;
            progressBar.style.width = progressPercentage + '%';
        }

        function drawHouse() {
            ctx.fillStyle = 'gray';
            ctx.fillRect(0, 0, 160, 80);
        }

        function drawLawnmowers() {
            lawnmowers.forEach(lawnmower => {
                const mowerImg = new Image();
                mowerImg.src = 'https://github.com/afanasi555/pvz/blob/main/assets/res/lawnmower/lawnmower.png';
                ctx.drawImage(mowerImg, lawnmower.x, lawnmower.y, gridWidth, gridHeight);
            });
        }

        function selectPlant(plantType) {
            if (plantType === 'sunflower' && suns >= 50) {
                selectedPlant = 'sunflower';
                suns -= 50;
            } else if (plantType === 'peashooter' && suns >= 100) {
                selectedPlant = 'peashooter';
                suns -= 100;
            }
        }

        canvas.addEventListener('click', function (e) {
            if (!selectedPlant) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const gridX = Math.floor(x / gridWidth) * gridWidth;
            const gridY = Math.floor(y / gridHeight) * gridHeight;

            if (gridY >= 80) {
                plants.push({
                    x: gridX,
                    y: gridY,
                    type: selectedPlant
                });
                selectedPlant = null;
            }
        });

        function openShop() {
            const shop = document.getElementById('shop');
            shop.style.display = 'block';
        }

        function closeShop() {
            const shop = document.getElementById('shop');
            shop.style.display = 'none';
        }

        function nextWave() {
            zombiesKilled = 0;
            zombiesToKill += 10;
            spawnZombies(currentLevel);
        }

        function continueGame() {
            currentLevel++;
            unlockNextPlant();
            document.getElementById('winScreen').style.display = 'none';
            nextWave();
        }

        function unlockNextPlant() {
            if (currentLevel === 2) {
                plantsUnlocked.push('repeater');
            } else if (currentLevel === 3) {
                plantsUnlocked.push('corn');
            }
            // Добавить другие растения по мере прохождения уровней
            updateShop();
        }

        function updateShop() {
            const shopButtons = document.querySelectorAll('#shop button');
            shopButtons.forEach(button => {
                if (plantsUnlocked.includes(button.innerText.toLowerCase())) {
                    button.style.display = 'inline';
                } else {
                    button.style.display = 'none';
                }
            });
        }

        function initGame() {
            updateShop();
            spawnZombies(currentLevel);
            gameLoop();
        }

        initGame();
    </script>
</body>
</html>
